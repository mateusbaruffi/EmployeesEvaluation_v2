<link rel="import" href="/lib/polymer/polymer.html" />
<link rel="import" href="/lib/paper-dropdown-menu/paper-dropdown-menu.html" />
<link rel="import" href="/lib/paper-item/paper-item.html" />
<link rel="import" href="/lib/paper-listbox/paper-listbox.html" />
<link rel="import" href="/lib/paper-input/paper-input.html" />
<link rel="import" href="/lib/paper-input/paper-textarea.html" />
<link rel="import" href="/lib/paper-button/paper-button.html" />
<link rel="import" href="/lib/paper-icon-button/paper-icon-button.html" />
<link rel="import" href="/lib/iron-icon/iron-icon.html" />
<link rel="import" href="/lib/iron-icons/iron-icons.html" />
<link rel="import" href="/lib/iron-iconset-svg/iron-iconset-svg.html" />
<link rel="import" href="/lib/paper-styles/paper-styles.html" />
<link rel="import" href="/lib/iron-ajax/iron-ajax.html" />
<link rel="import" href="/lib/iron-input/iron-input.html" />
<link rel="import" href="/lib/iron-form/iron-form.html" />
<link rel="import" href="/lib/paper-toolbar/paper-toolbar.html" />
<link rel="import" href="/lib/paper-autocomplete/paper-autocomplete.html" />
<link rel="import" href="question-card.html" />

<dom-module id="evaluation-form">
    <template>
        <style>
            paper-toolbar {
                background-color: #4a4646;
                margin-top: 10px;
                border-radius: 5px;
                width: 30%;
            }
        </style>
        <iron-ajax id="getDepartmentManagersAjax"
                   auto
                   method="get"
                   url="http://localhost:63585/Api/Users/GetDepartmentManagers"
                   handle-as="json"
                   last-response="{{departmentManagers}}"></iron-ajax>

        <iron-ajax id="getSeasonsAjax"
                   auto
                   method="get"
                   url="http://localhost:63585/Api/Seasons/GetAll"
                   handle-as="json"
                   last-response="{{seasons}}"></iron-ajax>

        <iron-ajax id="saveEvaluation"
                   method="post"
                   content-type="application/json"
                   handle-as="json"
                   on-response="handleSubmitResponse"
                   on-error="handleSubmitError"></iron-ajax>
        
        <div class="card">
            <form is="iron-form" method="post" action="/Api/Evaluations/Create" id="evaluationsForm" headers = '{"content-type":"application/json"}'>

                <paper-dropdown-menu label="Select a Department Manager" required>
                    <paper-listbox class="dropdown-content" selected="{{evaluationData.DepartmentManagerId}}" attr-for-selected="value">
                        <template is="dom-repeat" items="[[departmentManagers]]" as="departmentManager">
                            <paper-item value="[[departmentManager.Id]]">[[departmentManager.Email]]</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
                <input type="hidden" name="DepartmentManagerId" value="{{evaluationData.DepartmentManagerId}}" />
                <br />
                <paper-dropdown-menu label="Select a Season" required>
                    <paper-listbox class="dropdown-content" selected="{{evaluationData.SeasonId}}" attr-for-selected="value">
                        <template is="dom-repeat" items="[[seasons]]" as="season">
                            <paper-item value="[[season.Id]]">[[season.Name]]</paper-item>
                        </template>
                    </paper-listbox>
                </paper-dropdown-menu>
                <input type="hidden" name="SeasonId" value="{{evaluationData.SeasonId}}" />
                <br />

                <paper-input name="Title" label="Title" bind-value="{{evalutionData.Title}}" required></paper-input>
                <br />
                <paper-textarea label="Introduction" bind-value="{{evaluationData.Introduction}}" required></paper-textarea>
                <br />
                
                <template is="dom-repeat" items="[[questions]]" as="question">
                    <question-card form-data="{{question.formData}}" likert-answers="{{question.likertAnswers}}"></question-card>
                    <hr />
                   
                </template>

                <paper-toolbar>
                    <paper-icon-button on-tap="addQuestion" icon="add-circle" title="Add New Option"></paper-icon-button>
                    <paper-icon-button on-tap="removeQuestion" icon="remove-circle" title="Delete last Option"></paper-icon-button>
                    
                </paper-toolbar>
                <br /><br /><br />
                <paper-button raised on-tap="_submit">Submit</paper-button>
                
                <div class="output"></div>
            </form>
        </div>

    </template>
</dom-module>
<script>

    Polymer({
        is: 'evaluation-form',
        properties: {
            evaluationData: {
                type: Object,
                value: {}
            },
            formData: {
                type: Object,
                value: {}
            },
            likertAnswers: {
                type: Array,
                value: function () { return [{}] }
            },
            questions: {
                type: Array,
                value: function () { return [{ formData: {}, likertAnswers: [{}] }] }
            }
        },
        addQuestion: function () {
            this.push('questions', { formData: {}, likertAnswers: [{}] });
        },
        _submit: function (event) {

            // need refactore in child element to avoid this loop
            for (var i = 0; i < this.questions.length; i++) {
                console.log(this.questions[i].formData);
                if (this.questions[i].likertAnswers != undefined)
                    this.questions[i].formData.LikertAnswers = this.questions[i].likertAnswers;
            }

            for (var i = 0; i < this.questions.length; i++) {
                this.questions[i] = this.questions[i].formData;
            }

            this.evaluationData.Questions = this.questions;

            console.log(this.evaluationData);
            //console.log(this.questions);

            this.formData.LikertAnswers = this.likertAnswers;
            this.$.saveEvaluation.url = "http://localhost:63585/Api/Evaluations/Create";
            this.$.saveEvaluation.body = this.evaluationData;

            if (Polymer.dom(event).localTarget.parentElement.validate()) {
                this.$.saveEvaluation.generateRequest();
                console.log("------ validated and request sent ---");
            } else
                console.log("---- no validated" );
            
            //this.$.questionForm.submit();
        },
        handleSubmitResponse: function (event) {
            console.log(event.detail.response);
        }, 
        handleSubmitError: function (event) {
            console.log(event.detail);
        }
    });







</script>